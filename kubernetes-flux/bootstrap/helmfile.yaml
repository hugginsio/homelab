# https://helmfile.readthedocs.io/en/stable/
# yaml-language-server: $schema=https://json.schemastore.org/helmfile.json

helmDefaults:
  wait: true
  waitForJobs: true
  timeout: 600
  force: true

repositories:
  - name: prometheus-community
    url: "https://prometheus-community.github.io/helm-charts"
  - name: metrics-server
    url: "https://kubernetes-sigs.github.io/metrics-server/"
  - name: postfinance
    url: "https://postfinance.github.io/kubelet-csr-approver"
  - name: kyverno
    url: "https://kyverno.github.io/kyverno/"

# TODO: update metrics-server chart values
# TODO: update csr-approver-chart values
# TODO: install tailscale operator

releases:
  - name: prometheus-operator-crds
    namespace: default
    chart: "prometheus-community/prometheus-operator-crds"
    version: 18.0.0
  - name: kubelet-csr-approver
    namespace: kube-system
    chart: "postfinance/kubelet-csr-approver"
    version: 1.2.5
    values:
      - "../shared/kube-system/kubelet-csr-approver/values.yaml" # TODO: revisit these values
    needs:
      - "default/prometheus-operator-crds"
  - name: metrics-server
    namespace: kube-system
    chart: "metrics-server/metrics-server"
    version: 3.12.2
    values:
      - "../shared/kube-system/metrics-server/values.yaml" # TODO: revisit these values
    needs:
      - "default/prometheus-operator-crds"
      - kubelet-csr-approver
  - name: kyverno
    namespace: kyverno-system
    chart: "kyverno/kyverno"
    version: 3.3.7
    needs:
      - "default/prometheus-operator-crds"
      - "kube-system/kubelet-csr-approver"
      - "kube-system/metrics-server"
  - name: flux
    chart: "./fluxcd/"
    namespace: flux-system
    needs:
      - "default/prometheus-operator-crds"
      - "kube-system/kubelet-csr-approver"
      - "kube-system/metrics-server"
      - "kyverno-system/kyverno"
