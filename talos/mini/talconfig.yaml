# https://budimanjojo.github.io/talhelper/latest/
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/refs/tags/v3.0.36/pkg/config/schemas/talconfig.json

clusterName: &cluster mini
endpoint: https://kube.mini.internal:6443
additionalApiServerCertSans: &sans
  - "kube.mini.internal"
  - "127.0.0.1"
allowSchedulingOnControlPlanes: true

talosVersion: "v1.11.3"
kubernetesVersion: "v1.34.1"

nodes:
  - hostname: mini1
    certSANs: *sans
    controlPlane: true
    ipAddress: 10.0.2.21
    installDiskSelector:
      wwid: "naa.5001b444a8fcea74"
    nodeLabels:
      topology.kubernetes.io/region: homelab
      topology.kubernetes.io/zone: *cluster
    userVolumes:
      - name: data
        provisioning:
          diskSelector:
            match: disk.wwid == "naa.500a0751e8ab55ad"
          grow: true
          minSize: 30GiB
        filesystem:
          type: xfs
        encryption:
          # NOTE: this is not an incorrect type, despite what the schema says
          provider: luks2
          keys:
            - slot: 0
              static:
                passphrase: ${ENCRYPTION_PASSPHRASE}
    schematic:
      customization:
        extraKernelArgs:
          - "talos.dashboard.disabled=1"
        systemExtensions:
          officialExtensions:
            - "siderolabs/intel-ucode" # Intel microcode
            - "siderolabs/util-linux-tools" # Selection of Linux utils
    patches:
      - |-
        cluster:
          apiServer:
            admissionControl:
              - name: PodSecurity
                configuration:
                  apiVersion: pod-security.admission.config.k8s.io/v1alpha1
                  defaults:
                    audit: privileged
                    audit-version: latest
                    enforce: privileged
                    enforce-version: latest
                    warn: restricted
                    warn-version: latest
                  exemptions:
                    namespaces: []
                    runtimeClasses: []
                    usernames: []
                  kind: PodSecurityConfiguration
          discovery:
            enabled: false
          network:
            cni:
              # NOTE: modify this for temporary clusters
              name: none
          proxy:
            # NOTE: modify this for temporary clusters
            disabled: true
        machine:
          kubelet:
            extraArgs:
              rotate-server-certificates: true
          systemDiskEncryption:
            ephemeral:
              provider: luks2
              keys:
                - static:
                    passphrase: ${ENCRYPTION_PASSPHRASE}
                  slot: 0
          network:
            kubespan:
              enabled: false
            nameservers:
              - 10.0.2.1
